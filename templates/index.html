<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Smart Recipe Finder</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 40px auto; background: #f9f9f9; color: #333; }
        h1 { text-align: center; color: #d9534f; }
        #input-area { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        textarea { width: 100%; box-sizing: border-box; padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; min-height: 80px; }
        button { display: block; width: 100%; padding: 15px; font-size: 18px; font-weight: bold; background-color: #d9534f; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; transition: background-color 0.2s; }
        button:hover { background-color: #c9302c; }
        #results { margin-top: 30px; }
        #loading { text-align: center; font-size: 18px; display: none; }
        
        .recipe { background: #fff; border: 1px solid #eee; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
        .recipe h2 { margin-top: 0; color: #0275d8; cursor: pointer; } /* Made title clickable */
        .recipe h2:hover { text-decoration: underline; }
        .recipe-details { display: none; /* Hidden by default */ margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .recipe-details p { white-space: pre-wrap; line-height: 1.6; }
        .recipe-details img { max-width: 100%; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <h1>Smart Recipe Finder</h1>
    <p style="text-align: center;">Enter the ingredients you have, separated by commas:</p>
    
    <div id="input-area">
        <textarea id="ingredientsInput" placeholder="e.g., chicken, tomato, onion, garlic, rice..."></textarea>
        <button id="findButton">Find Recipes</button>
    </div>

    <div id="loading">Finding the best recipes...</div>
    <div id="results">
        </div>

    <script>
        const findButton = document.getElementById('findButton');
        const ingredientsInput = document.getElementById('ingredientsInput');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.getElementById('loading');

        // Main function to get the recipe list
        findButton.addEventListener('click', async () => {
            const ingredients = ingredientsInput.value;
            if (!ingredients) { alert('Please enter some ingredients!'); return; }

            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';

            try {
                // This calls your ML model endpoint
                const response = await fetch('/get_recipes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients: ingredients })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Network response was not ok');
                }

                const recipes = await response.json();
                loadingDiv.style.display = 'none';

                if (recipes.length === 0) {
                    resultsDiv.innerHTML = '<p>No matching recipes found. Try different ingredients!</p>';
                    return;
                }

                recipes.forEach((recipe, index) => {
                    const recipeDiv = document.createElement('div');
                    recipeDiv.className = 'recipe';
                    
                    // We give each recipe a unique ID
                    const recipeId = `recipe-${index}`;
                    
                    recipeDiv.innerHTML = `
                        <h2 data-title="${recipe.title}" onclick="fetchProcedure('${recipeId}', this)">
                            ${recipe.title} (Match: ${Math.round(recipe.score * 100)}%)
                        </h2>
                        <p><strong>Rating:</strong> ${recipe.rating} | <strong>Calories:</strong> ${recipe.calories} | <strong>Fat:</strong> ${recipe.fat} | <strong>Protein:</strong> ${recipe.protein}</p>
                        
                        <div id="${recipeId}" class="recipe-details">
                            <p>Loading instructions...</p>
                        </div>
                    `;
                    resultsDiv.appendChild(recipeDiv);
                });

            } catch (error) {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `<p>An error occurred: ${error.message}. Please try again.</p>`;
                console.error('Error:', error);
            }
        });

        // --- NEW FUNCTION ---
        // This is called when a user clicks a recipe title
        async function fetchProcedure(recipeId, element) {
            const detailsDiv = document.getElementById(recipeId);

            // Toggle display: if already open, close it.
            if (detailsDiv.style.display === 'block') {
                detailsDiv.style.display = 'none';
                return;
            }
            
            // Show the "Loading..." message
            detailsDiv.style.display = 'block';
            detailsDiv.innerHTML = '<p>Loading details...</p>';

            const title = element.getAttribute('data-title');

            try {
                // This calls your NEW /get_procedure endpoint
                const response = await fetch('/get_procedure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title })
                });
                
                if (!response.ok) throw new Error('Could not load procedure.');
                
                const data = await response.json();
                
                // Display the new info from Spoonacular
                detailsDiv.innerHTML = `
                    <img src="${data.image_url}" alt="${title}">
                    <h3>Instructions:</h3>
                    <p>${data.instructions}</p>
                `;

            } catch (error) {
                detailsDiv.innerHTML = `<p>Sorry, could not load instructions.</p>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>
